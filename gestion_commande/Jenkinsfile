pipeline {
    agent {
        label 'agent-windows'
    }

    environment {
        // Variables Docker
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE_NAME = 'fatymbengue/gestion-commande-backend'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_CREDENTIALS_ID = '0b645248-5ff1-4028-9402-f5c77efce425'  // Tes credentials Docker Hub
    }

    stages {
        // √âtape 1: Checkout du code
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/faty-mbengue/gestion-commande-backend.git',
                        credentialsId: 'tokenguitup'
                    ]]
                ])
            }
        }

        // √âtape 2: V√©rification Docker
        stage('Verify Docker') {
            steps {
                script {
                    echo "üîß V√©rification de Docker sur l'agent Windows..."

                    // V√©rifier si Docker est install√©
                    bat '''
                        echo V√©rification de Docker...
                        docker --version || echo "‚ùå Docker n'est pas install√©"
                        docker-compose --version || echo "‚ö† docker-compose n'est pas install√©"
                    '''

                    // V√©rifier si Docker Desktop est en cours d'ex√©cution
                    bat '''
                        echo V√©rification du service Docker...
                        sc query docker || echo "‚ö† Service Docker non trouv√©"
                    '''
                }
            }
        }

        // √âtape 3: Compilation
        stage('Compile') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd clean compile'
                }
            }
        }

        // √âtape 4: Tests
        stage('Test') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd test'
                }
            }
        }

        // √âtape 5: Packaging
        stage('Package') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd clean package -DskipTests'

                    // V√©rification du JAR g√©n√©r√©
                    bat '''
                        echo üì¶ V√©rification du fichier JAR...
                        if exist target\\*.jar (
                            echo ‚úÖ JAR g√©n√©r√© avec succ√®s
                            dir /b target\\*.jar
                        ) else (
                            echo ‚ùå Aucun JAR trouv√© dans target/
                            exit 1
                        )
                    '''
                }
            }
        }

        // √âtape 6: V√©rification Dockerfile
        stage('Verify Dockerfile') {
            steps {
                dir('gestion_commande') {
                    script {
                        echo "üìÑ V√©rification du Dockerfile..."

                        // V√©rifier si Dockerfile existe
                        def dockerfileExists = fileExists('Dockerfile')
                        if (!dockerfileExists) {
                            echo "‚ö† Dockerfile non trouv√©, cr√©ation d'un Dockerfile par d√©faut..."
                            // Cr√©er un Dockerfile par d√©faut
                            writeFile file: 'Dockerfile', text: '''# Dockerfile pour Spring Boot
FROM openjdk:21-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]'''
                            echo "‚úÖ Dockerfile cr√©√©"
                        }

                        // Afficher le contenu du Dockerfile
                        bat 'type Dockerfile'
                    }
                }
            }
        }

        // √âtape 7: Build de l'image Docker
        stage('Build Docker Image') {
            steps {
                script {
                    dir('gestion_commande') {
                        echo "üê≥ Construction de l'image Docker..."

                        // Construire l'image
                        bat """
                            docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} .
                            echo ‚úÖ Image Docker construite : ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                        """

                        // Ajouter le tag "latest"
                        bat """
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} ${DOCKER_IMAGE_NAME}:latest
                            echo ‚úÖ Tag latest ajout√©
                        """

                        // Lister les images locales
                        bat 'docker images | findstr "fatymbengue"'
                    }
                }
            }
        }

        // √âtape 8: Test de l'image Docker
        stage('Test Docker Image') {
            steps {
                script {
                    echo "üß™ Test de l'image Docker..."

                    // Tester si l'image peut √™tre ex√©cut√©e
                    bat """
                        echo Test de l'image Docker...
                        docker run --rm ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} --version || echo "‚ö† Impossible d'ex√©cuter avec --version"
                    """

                    // V√©rifier la taille de l'image
                    bat 'docker images --format "table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}" | findstr "fatymbengue"'
                }
            }
        }

        // √âtape 9: Push vers Docker Hub
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "üöÄ Envoi vers Docker Hub..."

                    // Login √† Docker Hub
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}",
                        usernameVariable: 'DOCKER_USERNAME',
                        passwordVariable: 'DOCKER_PASSWORD'
                    )]) {
                        bat """
                            echo Connexion √† Docker Hub...
                            echo %DOCKER_PASSWORD% | docker login ${DOCKER_REGISTRY} -u %DOCKER_USERNAME% --password-stdin
                            echo ‚úÖ Connect√© √† Docker Hub en tant que %DOCKER_USERNAME%
                        """
                    }

                    // Push de l'image avec le tag de build
                    bat """
                        echo Envoi de l'image ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}...
                        docker push ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                        echo ‚úÖ Image ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} envoy√©e
                    """

                    // Push de l'image avec le tag "latest"
                    bat """
                        echo Envoi de l'image ${DOCKER_IMAGE_NAME}:latest...
                        docker push ${DOCKER_IMAGE_NAME}:latest
                        echo ‚úÖ Image ${DOCKER_IMAGE_NAME}:latest envoy√©e
                    """

                    // Logout de Docker Hub
                    bat """
                        docker logout
                        echo ‚úÖ D√©connect√© de Docker Hub
                    """
                }
            }
        }

        // √âtape 10: Nettoyage local
        stage('Cleanup') {
            steps {
                script {
                    echo "üßπ Nettoyage des images locales..."

                    // Supprimer les images locales pour √©conomiser de l'espace
                    bat """
                        echo Suppression des images locales...
                        docker rmi ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} || echo "‚ö† Impossible de supprimer l'image tagu√©e"
                        docker rmi ${DOCKER_IMAGE_NAME}:latest || echo "‚ö† Impossible de supprimer l'image latest"
                    """
                }
            }
        }
    }

    post {
        success {
            echo """
            üéâ PIPELINE R√âUSSI ! üéâ

            üìä R√©sum√© :
            ‚úÖ Code compil√© et test√©
            ‚úÖ Application packag√©e en JAR
            ‚úÖ Image Docker construite
            ‚úÖ Image Docker publi√©e sur Docker Hub

            üì¶ Images disponibles sur Docker Hub :
            ‚Ä¢ ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
            ‚Ä¢ ${DOCKER_IMAGE_NAME}:latest

            üåê Lien : https://hub.docker.com/r/fatymbengue/gestion-commande-backend

            üöÄ Pour ex√©cuter l'application :
            docker run -p 8080:8080 ${DOCKER_IMAGE_NAME}:latest
            """

            // Optionnel : Envoyer une notification
            // emailext to: 'faty.mbengue@example.com',
            //        subject: "‚úÖ Build #${BUILD_NUMBER} r√©ussi",
            //        body: "L'image Docker a √©t√© publi√©e avec succ√®s."
        }

        failure {
            echo """
            ‚ùå PIPELINE √âCHOU√â ‚ùå

            üìã D√©pannage :
            1. V√©rifier si Docker est install√© sur l'agent
            2. V√©rifier les credentials Docker Hub
            3. V√©rifier la connexion internet
            4. V√©rifier l'espace disque disponible
            5. Consulter les logs d√©taill√©s ci-dessus
            """
        }

        always {
            echo "üßπ Nettoyage du workspace..."
            cleanWs()

            // Logout Docker pour √™tre s√ªr
            bat 'docker logout 2>nul || echo "D√©j√† d√©connect√©"'
        }
    }
}