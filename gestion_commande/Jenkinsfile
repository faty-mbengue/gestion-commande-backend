pipeline {
    agent {
        label 'agent-windows'
    }

    environment {
        // Variables Docker
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE_NAME = 'fatymbengue/gestion-commande-backend'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_CREDENTIALS_ID = '0b645248-5ff1-4028-9402-f5c77efce425'  // Tes credentials Docker Hub
    }

    stages {
        // √âtape 1: Checkout du code
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/faty-mbengue/gestion-commande-backend.git',
                        credentialsId: 'tokenguitup'
                    ]]
                ])
            }
        }

        // √âtape 2: V√©rification Docker (CORRIG√âE)
        stage('Verify Docker') {
            steps {
                script {
                    echo "üîß V√©rification de Docker sur l'agent Windows..."

                    // V√©rifier si Docker est install√© (version corrig√©e)
                    bat '''
                        echo V√©rification de Docker...
                        docker --version
                        if %errorlevel% neq 0 (
                            echo "‚ùå Docker n'est pas install√© ou ne fonctionne pas"
                            exit 1
                        )
                        echo ‚úÖ Docker est install√©
                    '''

                    // V√©rifier docker-compose
                    bat '''
                        docker-compose --version
                        if %errorlevel% neq 0 (
                            echo "‚ö† docker-compose n'est pas install√©"
                        ) else (
                            echo ‚úÖ docker-compose est install√©
                        )
                    '''
                }
            }
        }

        // √âtape 3: Compilation
        stage('Compile') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd clean compile'
                }
            }
        }

        // √âtape 4: Tests
        stage('Test') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd test'
                }
            }
        }

        // √âtape 5: Packaging
        stage('Package') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd clean package -DskipTests'

                    // V√©rification du JAR g√©n√©r√©
                    bat '''
                        echo üì¶ V√©rification du fichier JAR...
                        if exist target\\*.jar (
                            echo ‚úÖ JAR g√©n√©r√© avec succ√®s
                            dir /b target\\*.jar
                        ) else (
                            echo ‚ùå Aucun JAR trouv√© dans target/
                            exit 1
                        )
                    '''
                }
            }
        }

        // √âtape 6: V√©rification Dockerfile
        stage('Verify Dockerfile') {
            steps {
                dir('gestion_commande') {
                    script {
                        echo "üìÑ V√©rification du Dockerfile..."

                        // V√©rifier si Dockerfile existe
                        def dockerfileExists = fileExists('Dockerfile')
                        if (!dockerfileExists) {
                            echo "‚ö† Dockerfile non trouv√©, cr√©ation d'un Dockerfile par d√©faut..."
                            // Cr√©er un Dockerfile par d√©faut
                            writeFile file: 'Dockerfile', text: '''# Dockerfile pour Spring Boot
FROM openjdk:21-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]'''
                            echo "‚úÖ Dockerfile cr√©√©"
                        }

                        // Afficher le contenu du Dockerfile
                        bat 'type Dockerfile'
                    }
                }
            }
        }

        // √âtape 7: Build de l'image Docker
        stage('Build Docker Image') {
            steps {
                script {
                    dir('gestion_commande') {
                        echo "üê≥ Construction de l'image Docker..."

                        try {
                            // Construire l'image
                            bat """
                                docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} .
                                echo ‚úÖ Image Docker construite : ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                            """

                            // Ajouter le tag "latest"
                            bat """
                                docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} ${DOCKER_IMAGE_NAME}:latest
                                echo ‚úÖ Tag latest ajout√©
                            """

                            // Lister les images locales
                            bat 'docker images | findstr "fatymbengue"'
                        } catch (Exception e) {
                            echo "‚ùå Erreur lors de la construction de l'image Docker"
                            echo "V√©rifie que Docker Desktop est en cours d'ex√©cution"
                            error "Build Docker √©chou√©"
                        }
                    }
                }
            }
        }

        // √âtape 8: Test de l'image Docker
        stage('Test Docker Image') {
            steps {
                script {
                    echo "üß™ Test de l'image Docker..."

                    // Tester si l'image peut √™tre ex√©cut√©e (version simplifi√©e)
                    bat """
                        echo Test de l'image Docker en mode test...
                        docker images ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                        echo ‚úÖ Image Docker v√©rifi√©e
                    """
                }
            }
        }

        // √âtape 9: Push vers Docker Hub
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "üöÄ Envoi vers Docker Hub..."

                    try {
                        // Login √† Docker Hub
                        withCredentials([usernamePassword(
                            credentialsId: "${DOCKER_CREDENTIALS_ID}",
                            usernameVariable: 'DOCKER_USERNAME',
                            passwordVariable: 'DOCKER_PASSWORD'
                        )]) {
                            bat """
                                echo Connexion √† Docker Hub...
                                echo %DOCKER_PASSWORD% | docker login ${DOCKER_REGISTRY} -u %DOCKER_USERNAME% --password-stdin
                                if %errorlevel% neq 0 (
                                    echo "‚ùå √âchec de la connexion √† Docker Hub"
                                    exit 1
                                )
                                echo ‚úÖ Connect√© √† Docker Hub en tant que %DOCKER_USERNAME%
                            """
                        }

                        // Push de l'image avec le tag de build
                        bat """
                            echo Envoi de l'image ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}...
                            docker push ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                            if %errorlevel% neq 0 (
                                echo "‚ùå √âchec du push de l'image"
                                exit 1
                            )
                            echo ‚úÖ Image ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} envoy√©e
                        """

                        // Push de l'image avec le tag "latest"
                        bat """
                            echo Envoi de l'image ${DOCKER_IMAGE_NAME}:latest...
                            docker push ${DOCKER_IMAGE_NAME}:latest
                            if %errorlevel% neq 0 (
                                echo "‚ùå √âchec du push de l'image latest"
                                exit 1
                            )
                            echo ‚úÖ Image ${DOCKER_IMAGE_NAME}:latest envoy√©e
                        """

                    } finally {
                        // Toujours se d√©connecter
                        bat """
                            docker logout
                            echo ‚úÖ D√©connect√© de Docker Hub
                        """
                    }
                }
            }
        }

        // √âtape 10: Nettoyage local (optionnel)
        stage('Cleanup') {
            steps {
                script {
                    echo "üßπ Nettoyage des images locales..."

                    // Essayer de supprimer, mais ne pas √©chouer si √ßa ne marche pas
                    bat """
                        docker rmi ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} 2>nul || echo "Image tagu√©e d√©j√† supprim√©e ou non trouv√©e"
                        docker rmi ${DOCKER_IMAGE_NAME}:latest 2>nul || echo "Image latest d√©j√† supprim√©e ou non trouv√©e"
                        echo ‚úÖ Nettoyage termin√©
                    """
                }
            }
        }
    }

    post {
        success {
            echo """
            üéâ PIPELINE R√âUSSI ! üéâ

            üìä R√©sum√© :
            ‚úÖ Code compil√© et test√©
            ‚úÖ Application packag√©e en JAR
            ‚úÖ Image Docker construite
            ‚úÖ Image Docker publi√©e sur Docker Hub

            üì¶ Images disponibles sur Docker Hub :
            ‚Ä¢ ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
            ‚Ä¢ ${DOCKER_IMAGE_NAME}:latest

            üåê Lien : https://hub.docker.com/r/fatymbengue/gestion-commande-backend

            üöÄ Pour ex√©cuter l'application :
            docker run -p 8080:8080 ${DOCKER_IMAGE_NAME}:latest
            """
        }

        failure {
            echo """
            ‚ùå PIPELINE √âCHOU√â ‚ùå

            üìã D√©pannage :
            1. V√©rifier que Docker Desktop est en cours d'ex√©cution
            2. V√©rifier les credentials Docker Hub dans Jenkins
            3. V√©rifier la connexion internet de l'agent
            4. V√©rifier que le Dockerfile existe dans gestion_commande/
            5. V√©rifier que le JAR est bien g√©n√©r√©
            """
        }

        always {
            echo "üßπ Nettoyage du workspace..."
            cleanWs()

            // Logout Docker pour √™tre s√ªr
            bat 'docker logout 2>nul || echo "D√©j√† d√©connect√©"'
        }
    }
}