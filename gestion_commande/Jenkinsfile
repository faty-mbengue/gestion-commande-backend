pipeline {
    agent {
        label 'agent-windows'
    }

    environment {
        // Variables Docker
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE_NAME = 'fatymbengue/gestion-commande-backend'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_CREDENTIALS_ID = '0b645248-5ff1-4028-9402-f5c77efce425'
    }

    stages {
        // Ã‰tape 1: Checkout du code
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/faty-mbengue/gestion-commande-backend.git',
                        credentialsId: 'tokenguitup'
                    ]]
                ])
            }
        }

        // Ã‰tape 2: VÃ©rification Docker
        stage('Verify Docker') {
            steps {
                script {
                    echo "ðŸ”§ VÃ©rification de Docker..."

                    bat '''
                        docker --version
                        if %errorlevel% neq 0 (
                            echo "âŒ Docker n'est pas installÃ©"
                            exit 1
                        )
                        echo âœ… Docker est installÃ©
                    '''
                }
            }
        }

        // Ã‰tape 3: Compilation
        stage('Compile') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd clean compile'
                }
            }
        }

        // Ã‰tape 4: Tests
        stage('Test') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd test'
                }
            }
        }

        // Ã‰tape 5: Packaging
        stage('Package') {
            steps {
                dir('gestion_commande') {
                    bat 'mvnw.cmd clean package -DskipTests'

                    bat '''
                        if exist target\\*.jar (
                            echo âœ… JAR gÃ©nÃ©rÃ© avec succÃ¨s
                            dir /b target\\*.jar
                        ) else (
                            echo âŒ Aucun JAR trouvÃ©
                            exit 1
                        )
                    '''
                }
            }
        }

        // Ã‰tape 6: Mise Ã  jour du Dockerfile
        stage('Update Dockerfile') {
            steps {
                dir('gestion_commande') {
                    script {
                        echo "ðŸ“„ Mise Ã  jour du Dockerfile..."

                        // CrÃ©er/remplacer le Dockerfile avec une image valide
                        writeFile file: 'Dockerfile', text: '''# Dockerfile pour Spring Boot avec Java 21
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]'''

                        // Afficher le contenu
                        bat 'type Dockerfile'
                    }
                }
            }
        }

        // Ã‰tape 7: Build de l'image Docker
        stage('Build Docker Image') {
            steps {
                script {
                    dir('gestion_commande') {
                        echo "ðŸ³ Construction de l'image Docker..."

                        // Test de la connexion Docker Hub
                        bat '''
                            echo Test de la connexion Ã  Docker Hub...
                            docker pull eclipse-temurin:21-jre-alpine
                        '''

                        // Construire l'image
                        bat """
                            docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} .
                            echo âœ… Image construite : ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                        """

                        // Ajouter le tag latest
                        bat """
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} ${DOCKER_IMAGE_NAME}:latest
                        """

                        // Lister les images
                        bat 'docker images | findstr "fatymbengue"'
                    }
                }
            }
        }

        // Ã‰tape 8: Test de l'image Docker
        stage('Test Docker Image') {
            steps {
                script {
                    echo "ðŸ§ª Test rapide de l'image..."

                    bat """
                        docker run --rm ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} --version || echo "Test version Ã©chouÃ©, mais l'image existe"
                        echo âœ… Image Docker prÃªte
                    """
                }
            }
        }

        // Ã‰tape 9: Push vers Docker Hub
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "ðŸš€ Envoi vers Docker Hub..."

                    // Login Ã  Docker Hub
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        bat """
                            echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
                            if %errorlevel% neq 0 (
                                echo "âŒ Ã‰chec de la connexion Ã  Docker Hub"
                                exit 1
                            )
                        """
                    }

                    // Push de l'image
                    bat """
                        echo Envoi de l'image...
                        docker push ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
                        if %errorlevel% neq 0 (
                            echo "âŒ Ã‰chec du push de l'image taguÃ©e"
                            exit 1
                        )
                        echo âœ… Image ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} envoyÃ©e
                    """

                    // Push de latest
                    bat """
                        docker push ${DOCKER_IMAGE_NAME}:latest
                        if %errorlevel% neq 0 (
                            echo "âš  Ã‰chec du push de latest, mais tag principale envoyÃ©e"
                        ) else (
                            echo âœ… Image ${DOCKER_IMAGE_NAME}:latest envoyÃ©e
                        )
                    """

                    // Logout
                    bat '''
                        docker logout
                        echo âœ… DÃ©connectÃ© de Docker Hub
                    '''
                }
            }
        }

        // Ã‰tape 10: Nettoyage
        stage('Cleanup') {
            steps {
                script {
                    echo "ðŸ§¹ Nettoyage..."

                    bat '''
                        docker rmi ${DOCKER_IMAGE_NAME}:${DOCKER_TAG} 2>nul || echo "Image dÃ©jÃ  supprimÃ©e"
                        docker rmi ${DOCKER_IMAGE_NAME}:latest 2>nul || echo "Image latest dÃ©jÃ  supprimÃ©e"
                        docker system prune -f 2>nul || echo "Nettoyage Docker Ã©chouÃ©"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo """
            ðŸŽ‰ PIPELINE RÃ‰USSI ! ðŸŽ‰

            âœ… Code compilÃ© et testÃ©
            âœ… JAR gÃ©nÃ©rÃ©
            âœ… Image Docker construite
            âœ… Image publiÃ©e sur Docker Hub

            ðŸ“¦ Image : ${DOCKER_IMAGE_NAME}:${DOCKER_TAG}
            ðŸ“¦ Latest : ${DOCKER_IMAGE_NAME}:latest

            ðŸŒ Docker Hub : https://hub.docker.com/r/fatymbengue/gestion-commande-backend

            ðŸš€ Pour exÃ©cuter :
            docker run -p 8080:8080 fatymbengue/gestion-commande-backend:latest
            """
        }

        failure {
            echo """
            âŒ PIPELINE Ã‰CHOUÃ‰ âŒ

            ðŸ”§ DÃ©pannage :
            1. VÃ©rifier l'image Docker dans le Dockerfile
            2. VÃ©rifier la connexion Internet
            3. VÃ©rifier les credentials Docker Hub
            4. VÃ©rifier que Docker Desktop est en cours d'exÃ©cution
            """
        }

        always {
            // Nettoyage sans erreur
            bat 'docker logout 2>nul || echo ""'
            echo "ðŸ§¹ Fin du pipeline"
        }
    }
}